1. HEE 不再判斷
2.   POS終端的密鑰體系分成二級：終端主密鑰（TMK）和工作密鑰（WK）。其中TMK對WK進行加密保護。每臺POS終端擁有唯一的TMK，必須要有安全保護，保證只能寫入設備並參與計算，不能讀取；TMK是一個很關鍵的根密鑰，如果TMK被截取，工作密鑰就比較容易被破解，將嚴重威脅銀行卡支付安全。所以能否安全下載TMK到POS終端，成為整個POS終端安全性的關鍵。


LMK是加密機最頂層祕鑰，保密級別最高，稱之為本地主密鑰。LMK一般是由不同的人保管著不同的祕鑰份量，然後不同的保管員在加密機分別輸入自己保管的那一部分併合成一個LMK，沒有人能夠知道LMK的全部信息。ZMK（Zone Master Key）可以理解為區域主密鑰，TMK（Terminal Master Key）可以理解為終端收單主密鑰。LMK/ZMK/TMK均屬於保護祕鑰，保護祕鑰是用來加密保護工作祕鑰的，分層管理，不涉及到加密報文。

請問POS機有IMEI碼嗎？1.沒有。只有手機有IMEI碼。每臺pos機只有一個獨立的串碼或二維碼作為獨立唯一的表示。但這不是IMEI。

TWK（Terminal Working Key）

SAM 
1. 加解密
2. communication作用

批次上傳特店基本資料檔給設備倉儲系統
* Public Key：每一個 Terminal 必須向收單主機取得 Public Key，存放在 EDC Secure Area，用於供後續取得 TMK 之用
* Terminal Master Key（TMK）：每一個 Terminal 必須有獨立的 Master Key，存放在 EDC Secure Area，用於供後續更換 TWK 之用
* IAEK/IMEK（Dongle Key）： 用於驗證 Dongle 與 EDC 連結合理性之用
* Terminal Working Key（TWK）：用於交易當下為加密＂重要敏資＂欄位之用
* 銀聯 PIN Block Key（TPK）：用於交易當下為加密＂銀聯 PIN Block＂欄位所使用
* 每個交易種類會對應不同的 Terminal ID，須依下表說明進行必要的取/換 Key 作業

#### 加密機主密鑰（MK——Master Key）

加密機主密鑰是存入在HSM機內的由三個成分合成的一對最上層密鑰。在HSM機器以外的地方不會以明文形式存放，它採用雙倍標準DES密鑰（長達112位）實現三重數據加密。由於DES算法依靠某一個密鑰進行加密，同時所有密鑰和數據都經由MK進行加密，所以MK必須通過一種安全的方法生成和維護。MK由三個成分組成，32位十六進製數為一個成分。MK以密文行書存儲在加密機黑匣子中，且永遠不以明文形式出現。一般說來TMK通過MK加密後保持在數據庫中。

#### 終端主密鑰（TMK——Terminal Master Key）

TMK，主要作用是用來驗證工作密鑰是否合法，以及加密TAK、TPK，保證TAK和TPK在傳輸線路上地安全性。一般情況下，TMK是人工在POS設置或者通過IC卡導入，也有可能通過母POS下發。TMK被寫入密鑰保護芯片，此芯片具有自毀功能，能很好地保護TMK的安全性。TMK是和每一臺POS相關聯的，即主密鑰和POS設備是一一對應的。TMK又分為明文和密文，由具備銀聯認可資質的服務商下發（舉例：工商銀行、招商銀行、建設銀行）。如果是密文，則需要先解密，然後校驗，校驗通過後，在本地存儲。

如果終端主密鑰時密文，該如何解密呢？需要用KEK進行解密，那麼KEK又是什麼呢？KEK為密鑰加密密鑰。

#### 工作密鑰

工作密鑰也稱為數據密鑰，包含PIN密鑰，MAC密鑰以及磁道密鑰。在POS每次做簽到交易時，由POS中心下發給POS。存儲在本地，需要經常性地定期更換，通常每天更換一次。

#### PIN密鑰

終端PIN密鑰是一個數據加密用的密鑰，用於加密PIN，什麼是PIN呢？PIN就是你的銀行卡密碼。在簽到時，以密文的形式下發給POS終端，POS機接收到密文後，需要用TMK去解密，然後校驗，校驗通過後，將TPK存儲在專用地密鑰保護芯片裡。TPK用於加密在區域網路內POS終端和POS中心之間傳送地PIN。

TPK的用法：當你在密碼鍵盤上輸入銀行卡密碼時，輸出的是加密後的密文（通過TPK加密），那麼在網路傳輸中，一直都使用該密文，即使被截獲，得到的也是密文。

這裡有個注意點，就是校驗。通過校驗KCV，簽到的時候，下發給POS機的不僅有工作密鑰，還有每個密鑰的checkvalue。

#### 終端認證密鑰(TAK–Terminal Administrative Key)

終端認證密鑰用於計算校驗MAC。MAC是用來完成消息來源正確性鑑別，防止數據被篡改或非法用戶切入的數據。TAK也同樣是在簽到時，以密文的形式下發給POS終端，POS機接收到密文後，用TMK終端主密鑰解密，然後校驗，校驗通過後，將TAK存儲在專用的密鑰保護芯片裡。TAK用於區域網路內POS終端與POS中心之間傳送消息時，生成和校驗一個消息認證碼（Message Authentication Code), 從而達到消息認證的目的。TAK需要經常性地定期更換，通常每天更換一次。

#### POS機簽到的定義

POS機簽到一般分為操作員簽到和POS機簽到。

操作員簽到是驗證操作員的合法性，需要輸入操作員號和密碼，該簽到在POS機上完成，屬於脫機操作。  
POS簽到是驗證POS機的合法性，需要和POS中心發生通訊，POS簽到時一般會有數據接受發送對的提示，簽到時後臺會下發一個MAC（消息認證碼），之後的聯機操作都會上送這個MAC以確保交易發生在同一臺POS機上。

#### POS簽到的意義

為什麼要吃飽了撐著沒事幹，搞個POS簽到，直接進行交易不可以嗎？POS簽到主要是連接後臺驗證該POS機設備時合法的，以及下載最新的工作密鑰。POS設備硬件芯片在出廠時會設置唯一標識的設備ID。簽到就是POS設備向伺服器發起簽到請求，然後讓伺服器返回三個工作密鑰。POS簽到還將得到批次號。